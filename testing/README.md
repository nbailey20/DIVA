# Simple DIVA Test Environment

This directory contains a simple test environment for the DIVA (Detect, Inject, Verify, Alert) system using 1+ AWS Lambdas which can be chained together to mimic multi-step system workflows.

## Files
- `diva_tester.py`: Python script to create an IAM role with necessary permissions and a Lambda function chain.
- `build_diva_events.py`: Python script to generate event logic for this test environment.
- `event_logic.py`: Custom event logic for the Lambda functions in the chain, used by DIVA engine. This file is partially generated by `build_diva_events.py`.
- `main.tf`: Terraform configuration file to call the DIVA module in ../diva and set up the test environment.


## Usage
1. Execute `diva_tester.py` to create the IAM role and Lambda function chain of your desired length and widths. The chain structure is defined by a comma-separated list of integers, where each integer represents the number of Lambdas at that level in the chain.

```python
python diva_tester.py 1,2,1
```
This example creates a chain of 3 Lambda functions with the following structure:
    
  A  
  |  
+---+  
|   |  
B1  B2  
|   |  
+---+  
  |  
  C  

In this test environment, level N Lambdas will trigger all level N+1 Lambdas.
E.g. A triggers B1 and B2, and both B1 and B2 trigger C.


2. Use `build_diva_events.py` to generate the event logic for the custom Lambda chain automatically. This will output the event logic text that you can copy into `event_logic.py`.

Make sure to provide the same chain structure as used in `diva_tester.py`!

```python
python build_diva_events.py 1,2,1
```

This will output the event logic text for the specified chain structure.  
Replace the existing `events` dictionary in `event_logic.py` with the output from this script.

See also sample_event_logic.py in ./diva for a minimal example of event logic for reference.


3. Deploy the DIVA module using Terraform to set up DIVA and monitor the Lambda function chain.

```bash
terraform init
terraform apply
```

Checkout CloudWatch logs for the Lambda functions to see DIVA in action as it detects, injects, verifies, and alerts based on the defined event logic. If you want more detailed logs, you can adjust the logging level in `main.tf` with lambda_log_level = "DEBUG".


4. Inject failures by updating the CHILD_LAMBDAS environment variable of the Lambda functions in the chain.

If you remove a child Lambda, the parent Lambda will no longer invoke it, causing a failure that DIVA can detect and alert on depending on the architecture.


5. Run `terraform destroy` to remove all DIVA-related resources created by Terraform.

Also clean up resources by deleting the Lambda function chain and IAM role using `diva_tester.py`.

Make sure to provide the same chain structure as used in `diva_tester.py` the first time!

```python
python diva_tester.py 1,2,1 -d
```

All done!